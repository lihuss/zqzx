<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÁÆ°ÁêÜÈù¢Êùø - ËÇá‰∏≠2025</title>
    <link href="/lib/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/lib/fontawesome/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .admin-card {
            border-left: 4px solid;
            transition: transform 0.2s;
        }

        .admin-card:hover {
            transform: translateX(5px);
        }

        .admin-card.invite {
            border-color: #ffc107;
        }

        .admin-card.class {
            border-color: #198754;
        }

        .admin-card.report {
            border-color: #dc3545;
        }

        .tab-content {
            padding-top: 20px;
        }

        .report-preview {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.9rem;
        }
    </style>
</head>

<body class="app-page">
    <nav class="glass-nav fixed-top p-3 shadow-sm">
        <div class="container d-flex justify-content-between align-items-center">
            <a href="/hall" class="btn btn-sm btn-outline-success"><i class="fas fa-arrow-left"></i> ËøîÂõûÂ§ßÂéÖ</a>
            <span class="fw-bold fs-5 text-danger">üîí ÁÆ°ÁêÜÈù¢Êùø</span>
            <span class="badge bg-danger">ÁÆ°ÁêÜÂëò</span>
        </div>
    </nav>

    <div class="container" style="padding-top: 80px; max-width: 900px;">
        <% if (!user || !user.is_admin) { %>
            <div class="alert alert-danger text-center">
                <i class="fas fa-ban fa-2x mb-2"></i>
                <h5>Êó†ÊùÉËÆøÈóÆ</h5>
                <p>Ê≠§È°µÈù¢‰ªÖÈôêÁÆ°ÁêÜÂëò‰ΩøÁî®</p>
                <a href="/hall" class="btn btn-outline-danger">ËøîÂõûÂ§ßÂéÖ</a>
            </div>
            <% } else { %>
                <!-- Ê†áÁ≠æÈ°µÂØºËà™ -->
                <ul class="nav nav-tabs" id="adminTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="invite-tab" data-bs-toggle="tab" data-bs-target="#invite"
                            type="button">
                            <i class="fas fa-key text-warning me-1"></i> ÈÇÄËØ∑Á†ÅÁÆ°ÁêÜ
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="class-tab" data-bs-toggle="tab" data-bs-target="#class"
                            type="button">
                            <i class="fas fa-school text-success me-1"></i> Áè≠Á∫ßÁÆ°ÁêÜ
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="report-tab" data-bs-toggle="tab" data-bs-target="#report"
                            type="button">
                            <i class="fas fa-flag text-danger me-1"></i> ‰∏æÊä•Â§ÑÁêÜ
                            <% if (typeof reports !=='undefined' && reports.filter(r=> r.status === 'pending').length >
                                0) { %>
                                <span class="badge bg-danger">
                                    <%= reports.filter(r=> r.status === 'pending').length %>
                                </span>
                                <% } %>
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="adminTabContent">
                    <!-- ÈÇÄËØ∑Á†ÅÁÆ°ÁêÜ -->
                    <div class="tab-pane fade show active" id="invite" role="tabpanel">
                        <div class="glass-card p-4 mb-4 admin-card invite">
                            <h5 class="fw-bold mb-3"><i class="fas fa-plus-circle text-warning me-2"></i>ÁîüÊàêÁ≥ªÁªüÈÇÄËØ∑Á†Å</h5>
                            <form action="/admin/generate-code" method="POST" class="row g-3 align-items-center">
                                <div class="col-auto">
                                    <label class="form-label mb-0">ÁîüÊàêÊï∞ÈáèÔºö</label>
                                </div>
                                <div class="col-auto">
                                    <select name="count" class="form-select">
                                        <option value="1">1‰∏™</option>
                                        <option value="3">3‰∏™</option>
                                        <option value="5">5‰∏™</option>
                                        <option value="10">10‰∏™</option>
                                    </select>
                                </div>
                                <div class="col-auto">
                                    <button type="submit" class="btn btn-warning">
                                        <i class="fas fa-magic me-1"></i> ÁîüÊàê
                                    </button>
                                </div>
                            </form>

                            <% if (typeof newCodes !=='undefined' && newCodes && newCodes.length> 0) { %>
                                <div class="alert alert-success mt-4 mb-0">
                                    <strong>‚úÖ ÁîüÊàêÊàêÂäüÔºÅ</strong>
                                    <div class="mt-2">
                                        <% newCodes.forEach(code=> { %>
                                            <code class="d-block fs-5 mb-1"><%= code %></code>
                                            <% }) %>
                                    </div>
                                </div>
                                <% } %>
                        </div>

                        <div class="glass-card p-4">
                            <h5 class="fw-bold mb-3"><i class="fas fa-list text-info me-2"></i>Á≥ªÁªüÈÇÄËØ∑Á†ÅÂàóË°®</h5>
                            <% if (systemCodes.length===0) { %>
                                <p class="text-muted text-center mb-0">ÊöÇÊó†Á≥ªÁªüÈÇÄËØ∑Á†Å</p>
                                <% } else { %>
                                    <div class="table-responsive">
                                        <table class="table table-hover table-sm">
                                            <thead>
                                                <tr>
                                                    <th>ÈÇÄËØ∑Á†Å</th>
                                                    <th>Áä∂ÊÄÅ</th>
                                                    <th>‰ΩøÁî®ËÄÖ</th>
                                                    <th>ÂàõÂª∫Êó∂Èó¥</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% systemCodes.forEach(code=> { %>
                                                    <tr class="<%= code.used_by ? 'table-secondary' : '' %>">
                                                        <td><code><%= code.code %></code></td>
                                                        <td>
                                                            <span
                                                                class="badge <%= code.used_by ? 'bg-secondary' : 'bg-success' %>">
                                                                <%= code.used_by ? 'Â∑≤‰ΩøÁî®' : 'ÂèØÁî®' %>
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <%= code.used_by_username || '-' %>
                                                        </td>
                                                        <td>
                                                            <%= new Date(code.created_at).toLocaleDateString('zh-CN') %>
                                                        </td>
                                                    </tr>
                                                    <% }) %>
                                            </tbody>
                                        </table>
                                    </div>
                                    <% } %>
                        </div>
                    </div>

                    <!-- Áè≠Á∫ßÁÆ°ÁêÜ -->
                    <div class="tab-pane fade" id="class" role="tabpanel">
                        <div class="glass-card p-4 mb-4 admin-card class">
                            <h5 class="fw-bold mb-3"><i class="fas fa-plus-circle text-success me-2"></i>ÂàõÂª∫Êñ∞Áè≠Á∫ß</h5>
                            <form action="/admin/create-class" method="POST" class="row g-3 align-items-end">
                                <div class="col-auto">
                                    <label class="form-label">Â±ä</label>
                                    <select name="year" class="form-select">
                                        <option value="2025" selected>2025Â±ä</option>
                                        <option value="2024">2024Â±ä</option>
                                        <option value="2026">2026Â±ä</option>
                                    </select>
                                </div>
                                <div class="col">
                                    <label class="form-label">Áè≠Á∫ßÂêçÁß∞</label>
                                    <input type="text" name="className" class="form-control" placeholder="Â¶ÇÔºöÈ´ò‰∏â(15)Áè≠"
                                        required>
                                </div>
                                <div class="col-auto">
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-plus me-1"></i> ÂàõÂª∫Áè≠Á∫ß
                                    </button>
                                </div>
                            </form>
                        </div>

                        <div class="glass-card p-4">
                            <h5 class="fw-bold mb-3"><i class="fas fa-school text-info me-2"></i>Áè≠Á∫ßÂàóË°®</h5>
                            <% if (typeof classes !=='undefined' && classes.length> 0) { %>
                                <div class="table-responsive">
                                    <table class="table table-hover table-sm">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Áè≠Á∫ßÂêçÁß∞</th>
                                                <th>Â∏ñÂ≠êÊï∞</th>
                                                <th>ÂàõÂª∫Êó∂Èó¥</th>
                                                <th>Êìç‰Ωú</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% classes.forEach(cls=> { %>
                                                <tr>
                                                    <td>
                                                        <%= cls.id %>
                                                    </td>
                                                    <td>
                                                        <%= cls.full_name %>
                                                    </td>
                                                    <td>
                                                        <%= cls.post_count || 0 %>
                                                    </td>
                                                    <td>
                                                        <%= new Date(cls.created_at).toLocaleDateString('zh-CN') %>
                                                    </td>
                                                    <td>
                                                        <a href="/class/<%= cls.id %>"
                                                            class="btn btn-sm btn-outline-primary">
                                                            <i class="fas fa-eye"></i>
                                                        </a>
                                                        <form action="/admin/delete-class/<%= cls.id %>" method="POST"
                                                            class="d-inline"
                                                            onsubmit="return confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËØ•Áè≠Á∫ßÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ')">
                                                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </form>
                                                    </td>
                                                </tr>
                                                <% }) %>
                                        </tbody>
                                    </table>
                                </div>
                                <% } else { %>
                                    <p class="text-muted text-center mb-0">ÊöÇÊó†Áè≠Á∫ß</p>
                                    <% } %>
                        </div>
                    </div>

                    <!-- ‰∏æÊä•Â§ÑÁêÜ -->
                    <div class="tab-pane fade" id="report" role="tabpanel">
                        <div class="glass-card p-4 admin-card report">
                            <h5 class="fw-bold mb-3"><i class="fas fa-flag text-danger me-2"></i>ÂæÖÂ§ÑÁêÜ‰∏æÊä•</h5>

                            <% if (typeof reports==='undefined' || reports.filter(r=> r.status === 'pending').length ===
                                0) { %>
                                <div class="text-center text-muted py-4">
                                    <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                                    <p>ÊöÇÊó†ÂæÖÂ§ÑÁêÜÁöÑ‰∏æÊä•</p>
                                </div>
                                <% } else { %>
                                    <% reports.filter(r=> r.status === 'pending').forEach(report => { %>
                                        <div class="card mb-3">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <div>
                                                        <span class="badge bg-warning text-dark">ÂæÖÂ§ÑÁêÜ</span>
                                                        <small class="text-muted ms-2">
                                                            <%= new Date(report.created_at).toLocaleString('zh-CN') %>
                                                        </small>
                                                    </div>
                                                    <small class="text-muted">‰∏æÊä•‰∫∫: <%= report.reporter_name || 'ÂåøÂêç' %>
                                                            </small>
                                                </div>

                                                <div class="report-preview">
                                                    <strong>Ë¢´‰∏æÊä•Â∏ñÂ≠êÂÜÖÂÆπÔºö</strong>
                                                    <p class="mb-0 mt-1">
                                                        <%= report.post_content ? report.post_content.substring(0, 200)
                                                            + (report.post_content.length> 200 ? '...' : '') : 'Â∏ñÂ≠êÂ∑≤Âà†Èô§'
                                                            %>
                                                    </p>
                                                </div>

                                                <div class="d-flex gap-2 mt-3">
                                                    <a href="/class/<%= report.class_id %>"
                                                        class="btn btn-sm btn-outline-primary" target="_blank">
                                                        <i class="fas fa-eye me-1"></i>Êü•ÁúãÂ∏ñÂ≠ê
                                                    </a>
                                                    <form action="/admin/report/<%= report.id %>/delete-post"
                                                        method="POST" class="d-inline">
                                                        <button type="submit" class="btn btn-sm btn-danger"
                                                            onclick="return confirm('Á°ÆÂÆöÂà†Èô§ËØ•Â∏ñÂ≠êÂêóÔºü')">
                                                            <i class="fas fa-trash me-1"></i>Âà†Èô§Â∏ñÂ≠ê
                                                        </button>
                                                    </form>
                                                    <form action="/admin/report/<%= report.id %>/dismiss" method="POST"
                                                        class="d-inline">
                                                        <button type="submit" class="btn btn-sm btn-secondary">
                                                            <i class="fas fa-times me-1"></i>È©≥Âõû‰∏æÊä•
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                        <% }) %>
                                            <% } %>
                        </div>

                        <% if (typeof reports !=='undefined' && reports.filter(r=> r.status !== 'pending').length > 0) {
                            %>
                            <div class="glass-card p-4 mt-4">
                                <h6 class="text-muted mb-3">ÂéÜÂè≤ËÆ∞ÂΩï</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm small">
                                        <thead>
                                            <tr>
                                                <th>Êó∂Èó¥</th>
                                                <th>Áä∂ÊÄÅ</th>
                                                <th>Â∏ñÂ≠êID</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% reports.filter(r=> r.status !== 'pending').slice(0, 10).forEach(r => { %>
                                                <tr>
                                                    <td>
                                                        <%= new Date(r.created_at).toLocaleDateString('zh-CN') %>
                                                    </td>
                                                    <td>
                                                        <span
                                                            class="badge <%= r.status === 'resolved' ? 'bg-success' : 'bg-secondary' %>">
                                                            <%= r.status==='resolved' ? 'Â∑≤Â§ÑÁêÜ' : 'Â∑≤È©≥Âõû' %>
                                                        </span>
                                                    </td>
                                                    <td>#<%= r.post_id %>
                                                    </td>
                                                </tr>
                                                <% }) %>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <% } %>
                    </div>
                </div>
                <% } %>
    </div>

    <script src="/lib/bootstrap/js/bootstrap.bundle.min.js"></script>
</body>

</html>
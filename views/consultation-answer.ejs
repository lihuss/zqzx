<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>写回答 - 东湖畔 ZhaoHub</title>
    <link href="/lib/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/lib/fontawesome/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/treehole-style.css">
    <style>
        .btn-consultation {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border: none;
            color: white;
            padding: 0.75rem 2rem;
            border-radius: 9999px;
            font-weight: 700;
            box-shadow: 0 4px 14px rgba(37, 99, 235, 0.25);
        }

        .btn-consultation:hover {
            opacity: 0.9;
            color: white;
            transform: translateY(-1px);
        }

        .question-preview {
            background: #eff6ff;
            border-left: 4px solid #3b82f6;
            padding: 1rem 1.25rem;
            border-radius: 0 0.75rem 0.75rem 0;
            margin-bottom: 1.5rem;
        }

        .question-preview h5 {
            color: #1e40af;
            font-weight: 700;
            margin-bottom: 0;
        }

        .file-upload-box {
            width: 80px;
            height: 80px;
            border: 2px dashed #cbd5e1;
            border-radius: 0.75rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            color: #64748b;
            background-color: #f8fafc;
            transition: all 0.2s;
        }

        .file-upload-box:hover {
            border-color: #3b82f6;
            color: #3b82f6;
            background-color: #eff6ff;
        }

        .preview-item img {
            width: 80px;
            height: 80px;
            object-fit: cover;
        }
    </style>
</head>

<body>
    <nav class="warm-nav">
        <div class="container">
            <a href="/" class="nav-brand">
                <img src="/images/icon.png" alt="校徽">
                <span class="nav-brand-text d-none d-md-inline">东湖畔</span>
            </a>

            <!-- Tab 切换 -->
            <div class="nav-tabs-wrapper">
                <a href="/treehole" class="nav-tab">
                    <span>树洞</span>
                </a>
                <a href="/consultation" class="nav-tab active">
                    <span>咨询</span>
                </a>
                <a href="/market" class="nav-tab">
                    <span>集市</span>
                </a>
                <a href="/hall" class="nav-tab">
                    <span>回忆录</span>
                </a>
            </div>
            <div style="width: 100px;"></div>
        </div>
    </nav>

    <div class="container py-4">
        <div class="row justify-content-center">
            <div class="col-lg-6 col-md-8">
                <div class="treehole-card post-form-card">
                    <!-- 问题预览 -->
                    <div class="question-preview">
                        <small class="text-muted d-block mb-1"><i
                                class="fas fa-question-circle me-1"></i>正在回答的问题</small>
                        <h5>
                            <%= question.title %>
                        </h5>
                    </div>

                    <form action="/consultation/post" method="POST" enctype="multipart/form-data" id="answerForm">
                        <input type="hidden" name="type" value="answer">
                        <input type="hidden" name="parent_id" value="<%= question.id %>">

                        <div class="mb-3">
                            <textarea name="content" class="form-input-warm" rows="8" placeholder="写下你的回答，分享你的见解和经验..."
                                required></textarea>
                        </div>

                        <div class="mb-3">
                            <input type="file" id="imageUpload" name="image" accept="image/*" multiple
                                style="display: none;" onchange="handleFileSelect(this)">
                            <div class="d-flex flex-wrap gap-2" id="upload-grid">
                                <div class="upload-btn-wrapper" id="upload-btn-wrapper"
                                    onclick="document.getElementById('imageUpload').click()">
                                    <div class="file-upload-box">
                                        <i class="far fa-image"></i>
                                        <span>图片</span>
                                    </div>
                                </div>
                            </div>
                            <small class="text-muted mt-2 d-block" id="upload-hint">支持最多9张</small>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mt-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="anonymous" name="anonymous">
                                <label class="form-check-label small text-muted" for="anonymous">匿名回答</label>
                            </div>
                            <button type="submit" class="btn-consultation">
                                <i class="far fa-paper-plane me-2"></i>发布回答
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="/lib/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script>
        // 图片处理逻辑
        const dt = new DataTransfer();
        function handleFileSelect(input) {
            const files = input.files;
            for (let i = 0; i < files.length; i++) {
                let exists = false;
                for (let j = 0; j < dt.files.length; j++) {
                    if (dt.files[j].name === files[i].name && dt.files[j].size === files[i].size) {
                        exists = true; break;
                    }
                }
                if (!exists) dt.items.add(files[i]);
            }
            if (dt.files.length > 9) {
                alert('最多只能上传 9 张图片，已保留前 9 张');
                const newDt = new DataTransfer();
                for (let i = 0; i < 9; i++) {
                    newDt.items.add(dt.files[i]);
                }
                dt.items.clear();
                for (let i = 0; i < newDt.files.length; i++) {
                    dt.items.add(newDt.files[i]);
                }
            }
            input.files = dt.files;
            updatePreview();
        }

        function updatePreview() {
            const grid = document.getElementById('upload-grid');
            const btnWrapper = document.getElementById('upload-btn-wrapper');
            const hint = document.getElementById('upload-hint');
            const previews = grid.querySelectorAll('.preview-item');
            previews.forEach(el => el.remove());

            if (dt.files.length > 0) hint.textContent = `已选择 ${dt.files.length} / 9 张图片`;
            else hint.textContent = '支持最多9张';

            Array.from(dt.files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const div = document.createElement('div');
                    div.className = 'preview-item position-relative';
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'border rounded';
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'btn btn-danger btn-sm position-absolute top-0 end-0 p-0 d-flex justify-content-center align-items-center';
                    btn.style.cssText = 'width:20px;height:20px;transform:translate(30%, -30%);border-radius:50%';
                    btn.innerHTML = '&times;';
                    btn.onclick = function (ev) { ev.stopPropagation(); removeFile(index); };
                    div.appendChild(img);
                    div.appendChild(btn);
                    grid.insertBefore(div, btnWrapper);
                }
                reader.readAsDataURL(file);
            });

            if (dt.files.length >= 9) btnWrapper.style.display = 'none';
            else btnWrapper.style.display = 'block';
        }

        function removeFile(index) {
            const newDt = new DataTransfer();
            for (let i = 0; i < dt.files.length; i++) {
                if (i !== index) newDt.items.add(dt.files[i]);
            }
            dt.items.clear();
            for (let i = 0; i < newDt.files.length; i++) {
                dt.items.add(newDt.files[i]);
            }
            document.getElementById('imageUpload').files = dt.files;
            updatePreview();
        }
    </script>
</body>

</html>